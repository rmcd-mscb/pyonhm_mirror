stages:
  - debug
  - setup
  - run-operational

variables:
  HOME: "/home/gitlab-runner"
  CONDA_HOME: "$HOME/miniforge3"  # Adjust if Miniforge3 is installed elsewhere
  CONDA_ENV_NAME: "pyonhm"
  ENV_FILE_PATH: "$CI_PROJECT_DIR/nhm_conus.env"  # Assuming nhm_uc.env is in the repo
  LOG_DIR: "$HOME/pyonhm_logs"
  MINIFORGE_INSTALLER: "Miniforge3-Linux-x86_64.sh"
  MINIFORGE_URL: "https://github.com/conda-forge/miniforge/releases/latest/download/${MINIFORGE_INSTALLER}"
  PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$CONDA_HOME/bin"


setup_miniforge:
  stage: setup
  tags:
    - shell
    - docker
    - conda
    - pyonhm
  script:
    - |
      if [ ! -d "$CONDA_HOME" ]; then
        echo "Miniforge not found. Installing..."
        bash /tmp/${MINIFORGE_INSTALLER} -b -p $CONDA_HOME
      else
        echo "Miniforge is already installed at $CONDA_HOME"
      fi
    - source "$CONDA_HOME/etc/profile.d/conda.sh"
    - conda update -n base -c defaults conda -y
  artifacts:
    paths:
      - $CONDA_HOME
    expire_in: 1 hour
  when: manual
  allow_failure: false

clone_repository:
  stage: setup
  tags:
    - shell
    - docker
    - conda
    - pyonhm
  dependencies:
    - setup_miniforge
  script:
    - echo "Cloning the repository into the gitlab-runner home directory..."
    # Configure Git to use the PAT for authentication
    - git config --global url."https://${GITLAB_API_TOKEN}@code.usgs.gov/".insteadOf "https://code.usgs.gov/"
    # Navigate to the gitlab-runner home directory
    - cd /home/gitlab-runner/
    # Clone or update the repository
    - if [ -d "pyONHM" ]; then cd pyONHM && git pull; else git clone https://code.usgs.gov/wma/national-iwaas/nhm/pyONHM.git; fi
  only:
    - main  # Adjust according to your branch strategy
  when: manual


update_cfsv2_data:
  stage: run-operational
  tags:
    - shell
    - docker
    - conda
    - pyonhm
  script:
    - echo "Starting the run-operational job"

    # # Ensure HOME is set (GitLab CI sets it, but we reinforce it)
    # - export HOME="${HOME:-/home/$(whoami)}"

    # # Add Miniforge3 to PATH
    # - export PATH="$CONDA_HOME/bin:$PATH"

    # # Attempt to locate conda.sh dynamically
    # - CONDA_BASE=$(conda info --base 2>/dev/null)
    # - |
    #   if [ -n "$CONDA_BASE" ] && [ -f "$CONDA_BASE/etc/profile.d/conda.sh" ]; then
    #       source "$CONDA_BASE/etc/profile.d/conda.sh"
    #   elif [ -f "$CONDA_HOME/etc/profile.d/conda.sh" ]; then
    #       source "$CONDA_HOME/etc/profile.d/conda.sh"
    #   else
    #       echo "Conda initialization script not found."
    #       exit 1
    #   fi

    # # Activate the conda environment
    - conda activate "$CONDA_ENV_NAME"

    # Run update CFSv2 median forecast
    - pyonhm run-update-cfsv2-data --env-file "$ENV_FILE_PATH" --method median

    # Run update CFSv2 ensembles forecast
    - pyonhm run-update-cfsv2-data --env-file "$ENV_FILE_PATH" --method ensemble

    # Run operational model
    - pyonhm run-operational --env-file "$ENV_FILE_PATH"

    # forecasts 
    - pyonhm run-sub-seasonal --env-file "$ENV_FILE_PATH" --method median
    - pyonhm run-sub-seasonal --env-file "$ENV_FILE_PATH" --method ensemble

    # Deactivate the conda environment
    - conda deactivate

  # artifacts:
  #   paths:
  #     - "$LOG_DIR/pyonhm_cfsv2_cron_$(date '+%Y%m%d').log"
  #   expire_in: 1 week

  only:
    - schedules

